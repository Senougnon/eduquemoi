<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <meta name="description" content="Eduque Moi Studio - Plateforme IA multimodale pour l'√©ducation et la cr√©ativit√©">
    <meta name="theme-color" content="#4f46e5">
    <title>Eduque Moi - Studio AI</title>
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/css/shepherd.css"/>

    <!-- Scripts Externes -->
    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>
    <script src="https://cdn.fedapay.com/checkout.js?v=1.1.7"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Gemini SDK -->
    <script type="importmap">
        { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai@latest" } }
    </script>
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        window.GoogleGenerativeAI = GoogleGenerativeAI;
        console.log("‚úÖ Gemini SDK charg√©");
    </script>
</head>
<body>

    <div class="app-container">
        
        <!-- HEADER MOBILE (Visible uniquement sur mobile) -->
        <div class="mobile-header">
            <button class="btn-icon" onclick="toggleMobileSidebar()" title="Ouvrir le menu">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo">Eduque Moi</div>
            <div class="header-actions-mobile">
                <button class="btn-icon" onclick="toggleTheme()" title="Th√®me">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="btn-icon" onclick="newConversation()" title="Nouvelle conversation">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>

        <!-- SIDEBAR DE CONFIGURATION (Devient un tiroir sur mobile) -->
        <aside class="sidebar" id="appSidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-graduation-cap"></i> Studio
                </div>
                <div class="header-actions desktop-only">
                    <button class="btn-icon" onclick="newConversation()" title="Nouvelle conversation">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn-icon" onclick="toggleTheme()" title="Changer de th√®me">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
                <!-- Bouton fermer pour mobile -->
                <button class="btn-icon close-sidebar-btn" onclick="toggleMobileSidebar()" title="Fermer le menu">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="sidebar-scroll">
                <!-- User Info Panel -->
                <div id="userInfoPanel" class="config-panel hidden">
                    <div class="user-badge">
                        <i class="fas fa-user-circle"></i>
                        <span id="usernameDisplay">Invit√©</span>
                    </div>
                    <div class="credits-display">
                        <div class="credit-pill">
                            <small>Gratuit</small>
                            <span id="freeCredits">0</span>
                        </div>
                        <div class="credit-pill premium">
                            <small>Payant</small>
                            <span id="paidCredits">0</span>
                        </div>
                    </div>
                    <div class="sub-status" id="subscription">Aucun abonnement</div>
                    <button onclick="logout()" class="btn-full danger" style="margin-top: 10px;">
                        <i class="fas fa-sign-out-alt"></i> D√©connexion
                    </button>
                </div>

                <div id="authButtons" class="config-panel">
                    <p style="text-align: center; margin-bottom: 10px; color: var(--text-muted);">
                        Connectez-vous pour commencer
                    </p>
                    <button onclick="showLoginModal()" class="btn-full primary">
                        <i class="fas fa-sign-in-alt"></i> Connexion
                    </button>
                    <button onclick="showRegisterModal()" class="btn-full secondary" style="margin-top: 8px;">
                        <i class="fas fa-user-plus"></i> Inscription
                    </button>
                </div>

                <hr class="divider">

                <!-- NAVIGATION MODES (Visible sur Desktop UNIQUEMENT) -->
                <div class="nav-grid desktop-only">
                    <div class="nav-item active" onclick="switchMode('chat')" data-mode="chat">
                        <i class="fas fa-comment-dots"></i> Chat
                    </div>
                    <div class="nav-item" onclick="switchMode('image')" data-mode="image">
                        <i class="fas fa-image"></i> Image
                    </div>
                    <div class="nav-item" onclick="switchMode('video')" data-mode="video">
                        <i class="fas fa-video"></i> Vid√©o
                    </div>
                    <div class="nav-item" onclick="switchMode('audio')" data-mode="audio">
                        <i class="fas fa-music"></i> Audio
                    </div>
                </div>

                <hr class="divider">

                <!-- CONFIGURATION DYNAMIQUE -->
                <div id="config-section">
                    
                    <!-- Config Global: API Key -->
                    <div class="control-group">
                        <label><i class="fas fa-key"></i> Cl√© API (Optionnel)</label>
                        <div class="input-with-icon">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="manualApiKey" placeholder="Votre cl√© API personnelle...">
                        </div>
                        <small style="color: var(--text-muted);">Laissez vide pour utiliser la cl√© syst√®me</small>
                    </div>

                    <!-- Config Chat -->
                    <div id="cfg-chat" class="mode-config">
                        <div class="control-group">
                            <label><i class="fas fa-brain"></i> Mod√®le de raisonnement</label>
                            <select id="chat-model">
                                <option value="gemini-2.5-flash" selected>Gemini 2.5 Flash (Rapide)</option>
                                <option value="gemini-2.5-pro">Gemini 2.5 Pro (Avanc√©)</option>
                                <option value="gemini-3-pro-preview">Gemini 3 Pro (Premium)</option>
                            </select>
                        </div>
                        <div class="model-info">
                            <small>
                                <i class="fas fa-info-circle"></i> 
                                Flash: r√©ponses rapides ‚Ä¢ Pro: raisonnement complexe ‚Ä¢ 3 Pro: derni√®re g√©n√©ration
                            </small>
                        </div>
                    </div>

                    <!-- Config Image -->
                    <div id="cfg-image" class="mode-config hidden">
                        <div class="control-group">
                            <label><i class="fas fa-robot"></i> Mod√®le Image</label>
                            <select id="img-model">
                                <option value="gemini-2.5-flash-image" selected>Gemini 2.5 Flash Image</option>
                                <option value="gemini-3-pro-image-preview">Gemini 3 Pro Image</option>
                                <option value="imagen-4.0-generate-001">Imagen 4.0</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label><i class="fas fa-crop-alt"></i> Format d'image</label>
                            <select id="img-ratio">
                                <option value="1:1">Carr√© (1:1)</option>
                                <option value="16:9">Paysage (16:9)</option>
                                <option value="9:16">Portrait (9:16)</option>
                                <option value="4:3">Standard (4:3)</option>
                                <option value="3:4">Portrait Standard (3:4)</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label><i class="fas fa-palette"></i> Style artistique</label>
                            <select id="img-style">
                                <option value="" disabled selected>Choisir un style (Optionnel)</option>
                                <option value="photorealistic">Photor√©aliste</option>
                                <option value="illustration">Illustration</option>
                                <option value="anime">Anime / Manga</option>
                                <option value="digital-art">Art Digital</option>
                            </select>
                        </div>
                        <div class="model-info">
                            <small>
                                <i class="fas fa-magic"></i> 
                                Gemini 2.5/3: g√©n√©ration conversationnelle ‚Ä¢ Imagen: haute fid√©lit√©
                            </small>
                        </div>
                    </div>

                    <!-- Config Video -->
                    <div id="cfg-video" class="mode-config hidden">
                        <div class="control-group">
                            <label><i class="fas fa-film"></i> Mod√®le Vid√©o</label>
                            <select id="veo-model">
                                <option value="veo-3.1-generate-preview" selected>Veo 3.1 (Recommand√©)</option>
                                <option value="veo-3.1-fast-generate-preview">Veo 3.1 Fast</option>
                                <option value="veo-3.0-generate-preview">Veo 3.0</option>
                            </select>
                        </div>
                        <div class="row-inputs">
                            <div class="control-group">
                                <label><i class="fas fa-clock"></i> Dur√©e</label>
                                <select id="veo-duration">
                                    <option value="4">4 secondes</option>
                                    <option value="6">6 secondes</option>
                                    <option value="8" selected>8 secondes</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label><i class="fas fa-expand"></i> Qualit√©</label>
                                <select id="veo-res">
                                    <option value="720p" selected>720p HD</option>
                                    <option value="1080p">1080p Full HD</option>
                                </select>
                            </div>
                        </div>
                        <div class="model-info">
                            <small>
                                <i class="fas fa-video"></i> 
                                Veo 3.1 g√©n√®re des vid√©os 8s avec audio natif et r√©alisme am√©lior√©
                            </small>
                        </div>
                    </div>

                    <!-- Config Audio -->
                    <div id="cfg-audio" class="mode-config hidden">
                        <div class="control-group">
                            <label><i class="fas fa-robot"></i> Mod√®le TTS</label>
                            <select id="tts-model">
                                <option value="gemini-2.5-flash-preview-tts" selected>Gemini 2.5 Flash TTS</option>
                                <option value="gemini-2.5-pro-preview-tts">Gemini 2.5 Pro TTS</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label><i class="fas fa-microphone"></i> Voix de synth√®se</label>
                            <select id="tts-voice">
                                <option value="Puck">üßë Puck (Homme Neutre)</option>
                                <option value="Charon">üßî Charon (Homme Grave)</option>
                                <option value="Aoede" selected>üë© Aoede (Femme Douce)</option>
                                <option value="Kore">üíÉ Kore (Femme Dynamique)</option>
                                <option value="Fenrir">üê∫ Fenrir (Homme Puissant)</option>
                                <option value="Leda">üå∏ Leda (Femme Calme)</option>
                                <option value="Orus">üé≠ Orus (Homme Expressif)</option>
                                <option value="Zephyr">üå¨Ô∏è Zephyr (Non-binaire)</option>
                            </select>
                        </div>
                        <div class="model-info">
                            <small>
                                <i class="fas fa-volume-up"></i> 
                                TTS natif Gemini avec voix naturelles multilingues (30+ voix)
                            </small>
                        </div>
                    </div>
                </div>

                <hr class="divider">

                <!-- SHOP & EXTRAS -->
                <div class="extras-panel">
                    <button class="btn-outline w-100" onclick="toggleShop()">
                        <i class="fas fa-shopping-cart"></i> Boutique / Cr√©dits
                    </button>
                    <button class="btn-outline w-100" onclick="showReferralModal()" style="margin-top: 8px;">
                        <i class="fas fa-gift"></i> Parrainage (+5 cr√©dits)
                    </button>
                    <button class="btn-outline w-100" onclick="openLibrary()" style="margin-top: 8px;">
                        <i class="fas fa-book"></i> Ma Biblioth√®que
                    </button>
                </div>
                
<!-- Shop Panel dans le Sidebar -->
<div id="shopPanel" class="shop-panel hidden">
    <h5><i class="fas fa-crown"></i> Abonnements (Quota/Jour)</h5>
    <select id="subscriptionSelect" class="shop-select">
        <option value="24h">Pass 24h (50 Cr√©dits/j) - 500 FCFA</option>
        <option value="30d">Mensuel (35 Cr√©dits/j) - 8000 FCFA</option>
    </select>
    <button onclick="buySubscription()" class="btn-full primary" style="margin-top: 8px;">
        <i class="fas fa-check"></i> S'abonner
    </button>
    
    <h5 style="margin-top: 15px;"><i class="fas fa-coins"></i> Recharge Cr√©dits (Stock)</h5>
    <select id="creditSelect" class="shop-select">
        <option value="pack_eco">D√©couverte (20 Cr√©dits) - 300 FCFA</option>
        <option value="pack_std">Standard (100 Cr√©dits) - 1000 FCFA</option>
        <option value="pack_pro">Cr√©ateur (500 Cr√©dits) - 4500 FCFA</option>
    </select>
    <button onclick="buyCredits()" class="btn-full secondary" style="margin-top: 8px;">
        <i class="fas fa-plus"></i> Acheter Stock
    </button>
</div>
                
                <!-- HISTORIQUE -->
                <div id="historyList" class="history-list">
                    <!-- Historique g√©n√©r√© dynamiquement -->
                </div>
            </div>
        </aside>

        <!-- OVERLAY POUR LE TIROIR MOBILE -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileSidebar()"></div>

        <!-- MAIN CHAT AREA -->
        <main class="main-content">
            <div id="messageContainer" class="chat-area">
                <div class="welcome-message">
                    <div class="welcome-icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <h1>Bienvenue sur Eduque Moi Studio</h1>
                    <p>Votre assistant IA multimodal pour l'√©ducation et la cr√©ativit√©</p>
                    <div class="capabilities">
                        <span><i class="fas fa-brain"></i> Raisonnement avanc√©</span>
                        <span><i class="fas fa-image"></i> G√©n√©ration d'images</span>
                        <span><i class="fas fa-video"></i> Cr√©ation vid√©o Veo 3</span>
                        <span><i class="fas fa-file-alt"></i> Analyse de documents</span>
                    </div>
                    <div class="quick-start" style="margin-top: 20px;">
                        <p style="color: var(--text-muted); margin-bottom: 10px;">Essayez :</p>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                            <button class="btn-outline" onclick="document.getElementById('userInput').value='Explique-moi la relativit√© comme si j avais 10 ans'; sendMessage();">
                                üí° Expliquer un concept
                            </button>
                            <button class="btn-outline" onclick="switchMode('image'); document.getElementById('userInput').value='Un paysage fantastique avec des montagnes flottantes'; document.getElementById('userInput').focus();">
                                üé® Cr√©er une image
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- INPUT AREA -->
            <div class="composer-area">
                <!-- Zone de fichiers √©pingl√©s -->
                <div id="pinnedFilesArea" class="pinned-files hidden"></div>
                
                <div class="input-bar">
                    <input type="file" id="fileInput" hidden multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt" onchange="handleFileUpload(event)">
                    <button class="btn-icon" onclick="document.getElementById('fileInput').click()" title="Joindre un fichier (PDF, images, etc.)">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    
                    <textarea id="userInput" placeholder="Posez une question, analysez un document..." rows="1"></textarea>
                    
                    <button class="btn-icon" onclick="togglePromptList()" title="Biblioth√®que de prompts">
                        <i class="fas fa-magic"></i>
                    </button>
                    
                    <button id="sendBtn" class="btn-send" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <!-- Footer infos affich√©es sur Desktop, masqu√©es sur Mobile -->
                <div class="footer-info desktop-only">
                    <span id="modelIndicator">Gemini 2.5 Flash</span> ‚Ä¢ <span id="tokenCount">0 tokens</span>
                </div>
            </div>
        </main>
        
        <!-- BARRE DE NAVIGATION DU BAS (App-like, visible sur mobile) -->
        <nav class="mobile-bottom-nav">
            <a href="#" class="nav-item-mobile active" onclick="switchMode('chat')" data-mode="chat" title="Chat">
                <i class="fas fa-comment-dots"></i>
                <span>Chat</span>
            </a>
            <a href="#" class="nav-item-mobile" onclick="switchMode('image')" data-mode="image" title="Image">
                <i class="fas fa-image"></i>
                <span>Image</span>
            </a>
            <a href="#" class="nav-item-mobile" onclick="switchMode('video')" data-mode="video" title="Vid√©o">
                <i class="fas fa-video"></i>
                <span>Vid√©o</span>
            </a>
            <a href="#" class="nav-item-mobile" onclick="switchMode('audio')" data-mode="audio" title="Audio">
                <i class="fas fa-music"></i>
                <span>Audio</span>
            </a>
            <!-- Indicateur de cr√©dits d√©plac√© ici pour le mobile -->
            <div class="footer-credits nav-item-mobile" style="cursor: pointer;" onclick="toggleShop()" title="Cr√©dits restants">
                <i class="fas fa-coins"></i>
                <span id="footerCredits">0</span>
                <span style="font-size: 0.6em; display: block; margin-top: -2px;">Cr√©dits</span>
            </div>
        </nav>
    </div>

    <!-- MODALES (Laiss√©es inchang√©es pour leur contenu) -->
    
    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('loginModal')">&times;</span>
            <h2><i class="fas fa-sign-in-alt"></i> Connexion</h2>
            <div class="control-group">
                <label>Nom d'utilisateur</label>
                <input type="text" id="loginUsername" placeholder="Votre nom d'utilisateur">
            </div>
            <div class="control-group">
                <label>Mot de passe</label>
                <input type="password" id="loginPassword" placeholder="Votre mot de passe">
            </div>
            <button class="btn-full primary" onclick="login()">
                <i class="fas fa-check"></i> Se connecter
            </button>
            <p style="text-align: center; margin-top: 15px; color: var(--text-muted);">
                Pas encore de compte ? 
                <a href="#" onclick="closeModal('loginModal'); showRegisterModal();" style="color: var(--primary);">
                    Inscrivez-vous
                </a>
            </p>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('registerModal')">&times;</span>
            <h2><i class="fas fa-user-plus"></i> Inscription</h2>
            <div class="control-group">
                <label>Nom d'utilisateur</label>
                <input type="text" id="registerUsername" placeholder="Choisissez un nom d'utilisateur">
            </div>
            <div class="control-group">
                <label>Mot de passe</label>
                <input type="password" id="registerPassword" placeholder="Choisissez un mot de passe">
            </div>
            <button class="btn-full secondary" onclick="register()">
                <i class="fas fa-user-plus"></i> Cr√©er mon compte
            </button>
            <p style="text-align: center; margin-top: 10px; color: var(--secondary);">
                <i class="fas fa-gift"></i> 10 cr√©dits offerts √† l'inscription !
            </p>
        </div>
    </div>

    <!-- Prompt Library Modal -->
    <div id="promptListModal" class="modal">
        <div class="modal-content large-modal">
            <span class="close" onclick="closeModal('promptListModal')">&times;</span>
            <h2><i class="fas fa-magic"></i> Biblioth√®que de Prompts</h2>
            <p style="color: var(--text-muted); margin-bottom: 15px;">
                S√©lectionnez un prompt pr√©d√©fini pour commencer rapidement
            </p>
            <div class="prompt-grid">
                <ul id="promptCategories" class="category-list"></ul>
                <ul id="promptList" class="prompt-items-list"></ul>
            </div>
        </div>
    </div>

    <!-- Referral Modal -->
    <div id="referralModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('referralModal')">&times;</span>
            <h2><i class="fas fa-gift"></i> Programme de Parrainage</h2>
            <p style="color: var(--text-muted); margin-bottom: 15px;">
                Invitez vos amis et gagnez <strong style="color: var(--secondary);">5 cr√©dits</strong> par inscription !
            </p>
            
            <div class="control-group">
                <label>Votre lien de parrainage</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="referralLink" readonly style="flex: 1;">
                    <button class="btn-icon primary" onclick="copyReferralLink()" title="Copier">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
            
            <div class="stats-ref" style="margin-top: 20px; padding: 15px; background: var(--bg-panel); border-radius: 8px; text-align: center;">
                <div style="font-size: 2rem; color: var(--primary);">
                    <span id="totalReferrals">0</span>
                </div>
                <small style="color: var(--text-muted);">Personnes parrain√©es</small>
            </div>
            
            <div style="margin-top: 15px; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border: 1px solid var(--secondary);">
                <small style="color: var(--secondary);">
                    <i class="fas fa-info-circle"></i> 
                    Vos filleuls re√ßoivent aussi <strong>5 cr√©dits bonus</strong> !
                </small>
            </div>
        </div>
    </div>
    
    <!-- Library Modal (Assurez-vous qu'elle existe dans le DOM m√™me si elle est cr√©√©e dynamiquement) -->
    <!-- Une simple div suffit pour que JS la trouve: -->
    <div id="libraryModal" class="modal"></div>

    <script src="script.js"></script>
</body>
</html>